# AstrBot 消息撤回取消插件

> **作者**: 木有知  
> **仓库**: [https://github.com/muyouzhi6/astrbot_plugin_recall_cancel](https://github.com/muyouzhi6/astrbot_plugin_recall_cancel)  
> **版本**: v2.0.0  
> **标签**: 消息管理 | 撤回处理 | LLM控制 | 用户体验 | 自动化

## 📋 功能说明

当用户撤回触发 LLM 回应的消息时，如果 LLM 的回复还没发送出去，插件会自动取消发送。

**v2.0.0 新特性：**
- 🔗 **context_aware 联动**：撤回时同步清理 context_aware 插件中的消息记录，防止已撤回消息污染上下文
- 🔧 **完全重构**：修复消息 ID 匹配问题，确保撤回检测准确可靠
- ⚡ **高优先级处理**：确保撤回事件在其他插件之前处理

**解决场景：**
- 🚫 用户发错消息后撤回，但机器人仍然回复
- 🧹 撤回的消息不应出现在 LLM 的上下文历史中
- 🛡️ 防止恶意用户发送大量消息后撤回导致的资源浪费
- ⚡ 提升用户体验，避免无效回复

## 🔧 工作原理

```
用户发消息 → LLM 开始处理 → 用户撤回 → 插件拦截 → 取消回复 + 清理上下文
```

1. **📝 跟踪 LLM 请求**：监听 LLM 请求开始，记录消息 ID 和事件引用
2. **👂 监听撤回事件**：实时监听 QQ 平台的消息撤回通知事件（高优先级）
3. **❌ 智能取消**：检测到原消息被撤回时，立即停止正在处理的事件
4. **🔗 上下文清理**：如果安装了 context_aware 插件，同步删除已记录的消息
5. **🧹 自动清理**：定期清理过期记录，防止内存泄漏

## 🔌 支持平台

| 平台 | 状态 | 说明 |
|------|------|------|
| QQ (OneBot V11/NapCat) | ✅ 支持 | 完整支持群聊和私聊撤回检测 |
| Telegram | ❌ 不支持 | Telegram 撤回消息后无法获得原消息 ID |
| QQ 官方 | ❌ 不支持 | 官方 API 暂不提供撤回事件通知 |

## 🔗 context_aware 插件联动

如果同时安装了 [astrbot_plugin_context_aware](https://github.com/muyouzhi6/astrbot_plugin_context_aware) 插件（v2.5.1+），本插件会自动：

1. **删除用户消息**：从 context_aware 的会话历史中删除被撤回的消息
2. **删除 Bot 回复**：如果 Bot 的回复已被记录，也会一并删除

这确保了撤回的消息不会出现在后续的 LLM 上下文中，保持对话历史的准确性。

**注意**：即使不安装 context_aware，本插件也能正常工作（仅取消回复，不清理上下文）。

## ⚙️ 配置

本插件**开箱即用**，无需任何配置，安装后自动生效。

## 🧪 调试与测试

### 状态查询指令

发送 `/recall_stats` 查看插件运行统计：

```
📊 撤回取消插件统计
━━━━━━━━━━━━━━━━━━━━
检测撤回: 5 次
阻止请求: 3 次
阻止响应: 1 次
阻止发送: 1 次
清理上下文: 4 次
━━━━━━━━━━━━━━━━━━━━
当前待处理: 2 条
当前撤回记录: 3 条
```

### 功能测试步骤

1. **环境确认**：确保 QQ 客户端（如 NapCat）已正确连接
2. **触发测试**：发送能触发 LLM 回复的消息（如 `你好`）
3. **执行撤回**：在 LLM 回复发送前快速撤回原消息
4. **观察结果**：确认 AstrBot 停止发送回复
5. **状态验证**：使用 `/recall_stats` 查看插件工作状态

## 🔬 技术细节

### 实现架构

- **多层拦截**：在 `on_llm_request`、`on_llm_response`、`on_decorating_result` 三个阶段检查撤回状态
- **事件引用**：保存原始事件引用，支持跨 Task 停止事件处理
- **高优先级**：所有钩子使用 `priority=100`，确保在其他插件之前执行
- **消息 ID 提取**：正确从 `raw_message.message_id` 获取被撤回消息的真实 ID

### 性能优化

- **内存管理**：定期清理过期记录（默认 5 分钟后过期）
- **异步处理**：所有操作均为异步，不阻塞主流程
- **线程安全**：使用 `asyncio.Lock` 保护共享状态

### 数据结构

```python
PendingRequest:  # 正在处理的 LLM 请求
  - message_id: str      # 原始消息 ID
  - unified_msg_origin: str  # 会话标识
  - sender_id: str       # 发送者 ID
  - timestamp: float     # 请求时间戳
  - event: AstrMessageEvent  # 事件引用

RecalledMessage:  # 已撤回的消息
  - message_id: str      # 被撤回消息 ID
  - unified_msg_origin: str  # 会话标识
  - operator_id: str     # 撤回操作者 ID
  - timestamp: float     # 撤回时间戳
```

## 📚 版本历史

### v2.0.0 (2025-01-18)
- 🔄 **完全重构**：全新架构，修复核心消息 ID 匹配问题
- 🔗 **context_aware 联动**：撤回时同步清理 context_aware 中的消息记录
- ⚡ **高优先级处理**：确保撤回事件优先处理
- 📊 **统计命令**：新增 `/recall_stats` 查看运行统计
- 🔧 **事件引用**：保存事件引用，支持跨 Task 停止处理
- 🧹 **改进清理**：优化过期记录清理机制

### v1.2.0 (2025-09-15)
- 优化撤回检测逻辑

### v1.1.1 (2025-09-10)
- 修复部分场景下的检测失败

### v1.0.0 (2025-09-03)
- 🎉 **初始发布**：完整的消息撤回取消功能

---

**💡 提示**：建议同时安装 context_aware 插件以获得最佳体验，确保撤回的消息不会污染 LLM 上下文。
